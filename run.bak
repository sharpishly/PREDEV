#!/bin/bash

# ==========================================================
# Run SharpishlyApp with dependency checks
# ==========================================================

# --- Check dependencies ---
echo ">>> Checking dependencies..."
MISSING=0

check_dep() {
  if ! command -v "$1" &>/dev/null; then
    echo "❌ Missing dependency: $1"
    MISSING=1
  else
    echo "✅ Found: $1"
  fi
}

check_dep cmake
check_dep make
check_dep g++
check_dep ufw

if [ "$MISSING" -eq 1 ]; then
  echo "⚠️ Some dependencies are missing. Please install them with:"
  echo "    sudo apt update && sudo apt install -y build-essential cmake ufw"
  exit 1
fi

# ------------------------------
# Allow port 1966
# -----------------------------
echo ">>> Allow port 1966..."
sudo ufw allow 1966 || true

# ------------------------------
# Port status
# -----------------------------
echo ">>> Port status..."
sudo ufw status || true

# ------------------------------
# Set permissions
# -----------------------------
echo ">>> Set permissions..."
sudo chmod -R u+rwX SharpishlyApp/src/View

# ------------------------------
# Stop Nginx
# -----------------------------
echo ">>> Stop Nginx..."
sudo systemctl stop nginx 2>/dev/null || true
sudo service nginx stop 2>/dev/null || true

# ------------------------------
# List www directory
# -----------------------------
echo ">>> List www directory..."
ls -l SharpishlyApp/src/View/www

# ------------------------------
# Change to build directory
# -----------------------------
echo ">>> Change to build directory..."
cd SharpishlyApp/build

# ------------------------------
# Compile and build
# -----------------------------
echo ">>> Compile and build..."
cmake ..
make

# ------------------------------
# Run application
# -----------------------------
echo ">>> Run application..."
./SharpishlyApp
