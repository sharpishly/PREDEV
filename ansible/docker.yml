---
- hosts: localhost
  become: yes
  vars:
    app_dir: "/home/joe90/Documents/PREDEV/SharpishlyApp/app"
    certs_dir: "{{ app_dir }}/certs"
    crt_file: "{{ certs_dir }}/sharpishly.dev.crt"
    key_file: "{{ certs_dir }}/sharpishly.dev.key"
    domain: "sharpishly.dev"
  tasks:
    - name: Install Docker and OpenSSL packages
      package:
        name:
          - docker.io
          - docker-compose
          - openssl
        state: present

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create certs directory
      file:
        path: "{{ certs_dir }}"
        state: directory
        owner: joe90
        group: joe90
        mode: "0755"

    - name: Generate SSL private key
      command: openssl genrsa -out "{{ key_file }}" 4096
      args:
        creates: "{{ key_file }}"
      when: not (key_file is exists)

    - name: Generate self-signed SSL certificate
      command: >
        openssl req -x509 -new -nodes
        -key "{{ key_file }}"
        -out "{{ crt_file }}"
        -days 365
        -subj "/C=US/ST=California/L=Mountain View/O=Self-Signed/CN={{ domain }}"
      args:
        creates: "{{ crt_file }}"
      when: not (crt_file is exists)

    - name: Remove existing docker-compose.yml
      file:
        path: "{{ app_dir }}/docker-compose.yml"
        state: absent

    - name: Copy local-docker-compose.yml to docker-compose.yml
      copy:
        src: "{{ app_dir }}/local-docker-compose.yml"
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: joe90
        group: joe90
        mode: "0644"

    - name: Remove existing nginx directory
      file:
        path: "{{ app_dir }}/nginx"
        state: absent

    - name: Copy local-nginx to nginx
      copy:
        src: "{{ app_dir }}/local-nginx/"
        dest: "{{ app_dir }}/nginx"
        owner: joe90
        group: joe90
        mode: preserve

    - name: Set ownership for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        owner: joe90
        group: www-data
        recurse: yes

    - name: Set directory permissions for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        mode: "0755"
        recurse: yes
        state: directory

    - name: Set file permissions for dev.sharpishly.com
      shell: find "{{ app_dir }}/dev.sharpishly.com" -type f -exec chmod 644 {} \;
      changed_when: true

    - name: Set permissions for index.php
      file:
        path: "{{ app_dir }}/dev.sharpishly.com/website/public/index.php"
        mode: "0755"

    - name: Start Docker containers
      command: docker-compose up -d
      args:
        chdir: "{{ app_dir }}"
      register: docker_compose_up
      changed_when: docker_compose_up.rc == 0
      failed_when: docker_compose_up.rc != 0