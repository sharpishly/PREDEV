---
- hosts: localhost
  become: yes
  vars:
    app_dir: "/home/joe90/Documents/PREDEV/SharpishlyApp/app"
    certs_dir: "{{ app_dir }}/certs"
    crt_file: "{{ certs_dir }}/sharpishly.dev.crt"
    key_file: "{{ certs_dir }}/sharpishly.dev.key"
    domain: "sharpishly.dev"
    hostnames:
      - "sharpishly.dev"
      - "dev.sharpishly.dev"
      - "docs.sharpishly.dev"
      - "live.sharpishly.dev"
      - "py.sharpishly.dev"
  tasks:
    - name: Stop and remove Docker containers, volumes, and networks
      command: docker-compose down -v --remove-orphans
      args:
        chdir: "{{ app_dir }}"
      register: docker_compose_down
      changed_when: docker_compose_down.rc == 0
      failed_when: false

    - name: Stop all running Docker containers
      shell: docker ps -q | xargs -r docker stop
      changed_when: true
      failed_when: false

    - name: Remove all Docker containers
      shell: docker ps -aq | xargs -r docker rm -f
      changed_when: true
      failed_when: false

    - name: Remove dangling Docker images
      shell: docker images -f "dangling=true" -q | xargs -r docker rmi -f
      changed_when: true
      failed_when: false

    - name: Remove unused Docker volumes
      shell: docker volume ls -q | xargs -r docker volume rm -f
      changed_when: true
      failed_when: false

    - name: Remove unused Docker networks
      command: docker network prune -f
      changed_when: true
      failed_when: false

    - name: Check port 80 usage
      shell: |
        if command -v ss >/dev/null 2>&1; then
          ss -tulnp | grep ':80' || echo "Port 80 is free"
        else
          lsof -i :80 || echo "Port 80 is free"
        fi
      register: port_check
      changed_when: false
      failed_when: false
      args:
        executable: /bin/bash

    - name: Stop and disable Nginx service
      systemd:
        name: nginx
        state: stopped
        enabled: no
      ignore_errors: true

    - name: Add hostnames to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^\s*127\.0\.0\.1\s+{{ item }}(\s|$)'
        line: "127.0.0.1 {{ item }}"
        state: present
      loop: "{{ hostnames }}"

    - name: Install Docker and OpenSSL packages
      package:
        name:
          - docker.io
          - docker-compose
          - openssl
        state: present

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create certs directory
      file:
        path: "{{ certs_dir }}"
        state: directory
        owner: joe90
        group: joe90
        mode: "0755"

    - name: Generate SSL private key
      command: openssl genrsa -out "{{ key_file }}" 4096
      args:
        creates: "{{ key_file }}"
      when: not (key_file is exists)

    - name: Generate self-signed SSL certificate
      command: >
        openssl req -x509 -new -nodes
        -key "{{ key_file }}"
        -out "{{ crt_file }}"
        -days 365
        -subj "/C=US/ST=California/L=Mountain View/O=Self-Signed/CN={{ domain }}"
      args:
        creates: "{{ crt_file }}"
      when: not (crt_file is exists)

    - name: Remove existing docker-compose.yml
      file:
        path: "{{ app_dir }}/docker-compose.yml"
        state: absent

    - name: Copy local-docker-compose.yml to docker-compose.yml
      copy:
        src: "{{ app_dir }}/local-docker-compose.yml"
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: joe90
        group: joe90
        mode: "0644"

    - name: Remove existing nginx directory
      file:
        path: "{{ app_dir }}/nginx"
        state: absent

    - name: Copy local-nginx to nginx
      copy:
        src: "{{ app_dir }}/local-nginx/"
        dest: "{{ app_dir }}/nginx"
        owner: joe90
        group: joe90
        mode: preserve

    - name: Set ownership for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        owner: joe90
        group: www-data
        recurse: yes

    - name: Set directory permissions for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        mode: "0755"
        recurse: yes
        state: directory

    - name: Set file permissions for dev.sharpishly.com
      shell: find "{{ app_dir }}/dev.sharpishly.com" -type f -exec chmod 644 {} \;
      changed_when: true

    - name: Set permissions for index.php
      file:
        path: "{{ app_dir }}/dev.sharpishly.com/website/public/index.php"
        mode: "0755"

    - name: Start Docker containers
      command: docker-compose up -d
      args:
        chdir: "{{ app_dir }}"
      register: docker_compose_up
      changed_when: docker_compose_up.rc == 0
      failed_when: docker_compose_up.rc != 0

    - name: Verify hostnames in /etc/hosts
      shell: grep "{{ item }}" /etc/hosts
      loop: "{{ hostnames }}"
      register: hosts_check
      changed_when: false
      failed_when: hosts_check.rc != 0
      ignore_errors: true

    - name: Test http://sharpishly.dev
      command: curl -k http://sharpishly.dev
      register: http_test
      changed_when: false
      failed_when: http_test.rc != 0
      ignore_errors: true

    - name: Test https://sharpishly.dev
      command: curl -k https://sharpishly.dev
      register: https_test
      changed_when: false
      failed_when: https_test.rc != 0
      ignore_errors: true