---
- hosts: localhost
  become: yes
  vars:
    app_dir: "/home/joe90/Documents/PREDEV/SharpishlyApp/app"
  tasks:
    - name: Install Docker packages
      package:
        name:
          - docker.io
          - docker-compose
        state: present

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Remove existing docker-compose.yml
      file:
        path: "{{ app_dir }}/docker-compose.yml"
        state: absent

    - name: Copy local-docker-compose.yml to docker-compose.yml
      copy:
        src: "{{ app_dir }}/local-docker-compose.yml"
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: joe90
        group: joe90
        mode: "0644"

    - name: Remove existing nginx directory
      file:
        path: "{{ app_dir }}/nginx"
        state: absent

    - name: Copy local-nginx to nginx
      copy:
        src: "{{ app_dir }}/local-nginx/"
        dest: "{{ app_dir }}/nginx"
        owner: joe90
        group: joe90
        mode: preserve

    - name: Set ownership for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        owner: joe90
        group: www-data
        recurse: yes

    - name: Set directory permissions for dev.sharpishly.com
      file:
        path: "{{ app_dir }}/dev.sharpishly.com"
        mode: "0755"
        recurse: yes
        state: directory

    - name: Set file permissions for dev.sharpishly.com
      shell: find "{{ app_dir }}/dev.sharpishly.com" -type f -exec chmod 644 {} \;
      changed_when: true

    - name: Set permissions for index.php
      file:
        path: "{{ app_dir }}/dev.sharpishly.com/website/public/index.php"
        mode: "0755"

    - name: Start Docker containers
      command: docker-compose up -d
      args:
        chdir: "{{ app_dir }}"
      register: docker_compose_up
      changed_when: docker_compose_up.rc == 0
      failed_when: docker_compose_up.rc != 0